# add .tex conversion and (and .pdf rendering of .tex file) to a pull request that adds/modifies a cgel tree.
# currently assumes cgel file(s) in datasets/oneoff.

name: Create tree .tex and .pdf 

on:
  push:
    paths:
      - datasets/oneoff/*.cgel
    branches-ignore:
      - main      

jobs:
  render:
    runs-on: ubuntu-latest
    permissions: 
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          submodules: true
          fetch-depth: 0

      - name: Update to make sure we have a newly created branch
        run: |
          git branch -v
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get changed files excluding merge-only changes
        run: |
          # Fetch main branch for comparison
          git fetch origin main:main
          
          # Find all merge commits since branching from main
          MERGE_BASE=$(git merge-base origin/main HEAD)
          MERGE_COMMITS=$(git log --merges --format=%H $MERGE_BASE..HEAD)
          
          # Get all changed files since branching from main (no path restriction)
          ALL_CHANGES=$(git diff --name-only $MERGE_BASE HEAD)
          
          # Initialize empty array for merge-only changes
          declare -A MERGE_ONLY_CHANGES
          
          # For each merge commit, get its changes and mark them as merge changes
          for merge_commit in $MERGE_COMMITS; do
            # Get the parents of the merge commit
            parent1=$(git rev-parse $merge_commit^1)
            parent2=$(git rev-parse $merge_commit^2)
            
            # Get changes that came from main branch (parent2) in this merge
            # No path restriction here - look at all files
            merge_changes=$(git diff --name-only $parent2 $merge_commit)
            
            # Mark these as merge-only changes unless they were also modified in non-merge commits
            for file in $merge_changes; do
              # Check if file was modified in any non-merge commit
              non_merge_changes=$(git log --no-merges --format=%H $MERGE_BASE..HEAD -- "$file")
              if [[ -z "$non_merge_changes" ]]; then
                MERGE_ONLY_CHANGES[$file]=1
              fi
            done
          done
          
          # Build final list of files excluding merge-only changes
          FINAL_DIFF=""
          for file in $ALL_CHANGES; do
            if [[ -z "${MERGE_ONLY_CHANGES[$file]}" ]]; then
              FINAL_DIFF="$FINAL_DIFF $file"
            fi
          done
          
          # Trim leading/trailing whitespace and set environment variable
          FINAL_DIFF=$(echo $FINAL_DIFF | xargs)
          echo "DIFF_FILES=$FINAL_DIFF" >> $GITHUB_ENV
          
          # Debug output
          echo "All changes since branching from main: $ALL_CHANGES"
          echo "Final diff (cgel files excluding merge-only changes): $FINAL_DIFF"
          
      - name: Config github actions bot
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python 3.10
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"
          cache: 'pip'
      - run: pip install -r cgel/requirements.txt

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Generate .tex and .pdf files
        env:
          SERVICE_URL: ${{ secrets.LATEX_SERVICE_URL }}
          CREDS: ${{ secrets.TEXLIVE_API_CREDS }}
        run: |
          mkdir -p datasets/oneoff/tex
          mkdir -p datasets/oneoff/pdf
          # Only iterate through cgel files
          for changed_file in ${DIFF_FILES}; do
            if [[ -n "$changed_file" ]] && [[ "$changed_file" == datasets/oneoff/*.cgel ]]; then
              filename=$(basename "$changed_file")
              tree_name="${filename%.cgel}"
              # make .tex
              python cgel/tree2tex.py "${changed_file}" > "datasets/oneoff/tex/$tree_name.tex"
              # make .pdf 
              jq -n --arg latex "$(cat datasets/oneoff/tex/$tree_name.tex)" '{"latex_code": $latex}' | curl -X POST "$SERVICE_URL" -u $CREDS -H "Content-Type: application/json" -d @- --output datasets/oneoff/pdf/$tree_name.pdf
            fi
          done   

      - name: Commit and push .tex and .pdf files 
        run: |
          # Only iterate through cgel files
          for changed_file in ${DIFF_FILES}; do
            if [[ -n "$changed_file" ]] && [[ "$changed_file" == datasets/oneoff/*.cgel ]]; then
              filename=$(basename "$changed_file")
              tree_name="${filename%.cgel}"
              git add "datasets/oneoff/tex/$tree_name.tex"
              git add "datasets/oneoff/pdf/$tree_name.pdf"
              git commit -m "generated tex and pdf files for $filename"
            fi
          done   
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
